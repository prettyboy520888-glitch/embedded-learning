# 51 单片机数码管显示（段选/位选）说明（基于原理图：P0→74HC245→段线，P2→74HC138→位选）

## 1. 系统概览

本项目使用 51 单片机驱动 8 位数码管（两组 SMG1/SMG2，每组 4 位）：

- **段选（Segment Select）**：决定显示“形状/数字”，即 a、b、c、d、e、f、g、dp 8 根段线。
  - 由 **P0.0~P0.7** 输出，经 **74HC245** 缓冲，再经 **100Ω 电阻阵列** 限流后接到数码管段线。
- **位选（Digit Select）**：决定“哪一位亮”，即每一位数码管的 COM（公共端）。
  - 由 **74HC138（三八译码器）**控制 **Y0~Y7**，通常对应 LED1~LED8（8 位公共端通道）。

> 结论：  
> - **P0 负责段选**  
> - **P2(三根线) + 74HC138 负责位选**

---

## 2. 段选：如何确定 P0 的每一位对应哪一段

### 2.1 原理图连线结论（重要）

从原理图可顺线得到：`P00~P07 → 74HC245(A0~A7) → 74HC245(B0~B7) → 电阻阵列 → a~dp`

因此通常对应关系为（bit0 最低位）：

| P0 位 | 74HC245 输出 | 数码管段线 |
|------|--------------|------------|
| P0.0 | B0           | a          |
| P0.1 | B1           | b          |
| P0.2 | B2           | c          |
| P0.3 | B3           | d          |
| P0.4 | B4           | e          |
| P0.5 | B5           | f          |
| P0.6 | B6           | g          |
| P0.7 | B7           | dp         |

> 原理图里 a~dp 下方的数字（如 11、7、4、2、1、10、5、3）是 **数码管模块的引脚号**，不是段编号。

### 2.2 最可靠的“段位验证法”（建议必做）

固定选通某一位（位选保持不变），然后让 P0 逐位输出单 bit：

- `P0 = 0x01` → 应只亮 a
- `P0 = 0x02` → 应只亮 b
- `P0 = 0x04` → 应只亮 c
- …
- `P0 = 0x80` → 应只亮 dp

若出现“写 1 反而灭、写 0 反而亮”，说明你的硬件是 **低电平点亮段**（常见于共阳/反向驱动），段码需要整体取反：
- 共阴（常见）：`1=亮`
- 共阳（常见）：`0=亮`，应使用 `P0 = ~seg;`

---

## 3. 位选：三八译码器（74HC138）怎么切换

### 3.1 74HC138 基本规律

74HC138 典型特性：
- 输入：A（最低位）、B、C（最高位）
- 输出：Y0~Y7 **低有效**（被选中的一路输出为 0，其余为 1）
- 使能脚：G1（高有效），/G2A、/G2B（低有效）
  - 必须满足：`G1=1 且 /G2A=0 且 /G2B=0`，译码才生效。

### 3.2 选择表（CBA→Yx）

在使能成立时：

| C B A | 被选中的输出（=0） |
|------|---------------------|
| 0 0 0 | Y0 |
| 0 0 1 | Y1 |
| 0 1 0 | Y2 |
| 0 1 1 | Y3 |
| 1 0 0 | Y4 |
| 1 0 1 | Y5 |
| 1 1 0 | Y6 |
| 1 1 1 | Y7 |

### 3.3 对应到单片机端口（常见：P2_2/P2_3/P2_4 → A/B/C）

若开发板连接为：
- `P2_2 -> A`
- `P2_3 -> B`
- `P2_4 -> C`

则：

```c
void Nixie_Select(unsigned char n)  // n=0~7
{
    P2_2 = (n & 0x01);       // A
    P2_3 = (n & 0x02) >> 1;  // B
    P2_4 = (n & 0x04) >> 2;  // C
}
